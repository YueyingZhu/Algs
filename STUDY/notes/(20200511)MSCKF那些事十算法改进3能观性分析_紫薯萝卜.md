# MSCKF那些事（十）算法改进3：能观性分析

 **Author:** [紫薯萝卜]

 **Link:** [https://zhuanlan.zhihu.com/p/78005491]

对于VIO系统，在重力加速度已知但特征未知的前提下，它有4个维度是不能观的：全局位置（3DoF），绕重力轴方向的旋转（1DoF），也就是yaw角。然而，在实际MSCKF中，由于Jacobian的计算使用了状态量在不同时刻估计值，使得系统不能观的维度从4变成了3，yaw角被错误的能观了，相当于MSCKF使用的离散线性模型与真实模型不一致（Inconsistency），**系统会错误地认为yaw角带有很多的信息，从而较少估计（Under-estimate）其协方差，**最终导致VIO的精度下降。能观性改进的目的就是要消除这种不一致性，提高VIO精度。

这一块的论文理论比较复杂，在看论文的过程中或多或少会有一些疑问：

1. 为什么VIO真实系统不能观的维度是4（位置和yaw角）？
2. 能观性是什么？能观性维度不一致为什么会影响精度？
3. 如何证明MSCKF的系统不能观的维度是3？
4. 就算系统不能观的维度从4变为了3，如何确定是yaw角那一维被错误的能观了呢？
5. 如何调整系统的能观性矩阵，使其yaw重新变回不能观？

问题1在[1], [2]中有介绍，能观性的论文基本上把它当成结论在用，有兴趣的同学可以看参考文献。下面对问题2-5进行展开，先了解能观性定义（问题2），然后对MSCKF系统进行能观性分析（问题3,4），接着讨论改进方法（问题5）。老实说，笔者对这几个问题并没有理解透彻，希望有懂的大神能不吝赐教。

## 1. 能观性定义  
对于非线性系统模型：

$$
\begin{aligned} 
\dot{\mathbf{x}} &=f(\mathbf{x}, \mathbf{u})+\mathbf{w} \\ 
\mathbf{z} &=h(\mathbf{x})+\mathbf{n} 
\end{aligned}
$$

其中， $\mathbf{x}$ 为状态， $\mathbf{u}$ 为控制输入， $\mathbf{z}$ 为观测， $\mathbf{w},\mathbf{n}$ 为噪声，第一个等式为状态转移模型（运动模型），第二个等式为观测模型。EKF对非线性系统离散线性化如下：

$$
\begin{aligned} 
\tilde{\mathbf{x}}_{k+1} &=\mathbf{\Phi}_{k} \tilde{\mathbf{x}}_{k}+\mathbf{w}_{d_{k}} \\ 
\tilde{\mathbf{z}}_{k} &=\mathbf{H}_{k} \tilde{\mathbf{x}}_{k}+\mathbf{n}_{k} 
\end{aligned}
$$

其中， $\mathbf{\Phi}_{k}$ 为误差状态转移矩阵， $\mathbf{H}_{k}$ 为观测矩阵。

线性系统的能观性矩阵定义为：

$\mathcal{O} \triangleq\left[\begin{array}{c}{\mathbf{H}_{k}} \\ {\mathbf{H}_{k+1} \mathbf{\Phi}_{k}} \\ {\vdots} \\ {\mathbf{H}_{k+m} \mathbf{\Phi}_{k+m-1} \cdots \mathbf{\Phi}_{k}}\end{array}\right]\\$

能观性矩阵的零空间定义为：

$\mathcal{O} \cdot \mathbf{N}= \mathbf{0}\\ $

**能观性矩阵的秩 $rank(\mathcal{O})$表示系统能观的维度，零空间的秩 $rank(N)$表示系统不能观的维度**。

EKF公式（状态转移、状态更新、Kalman增益）中使用的是线性系统模型，所以线性模型的能观性在EKF估计中至关重要。理想状态下，线性系统的能观性应该要与真实非线性模型一致，但由于线性化点或线性化方法的不一样，可能导致离散模型的能观性与真实模型不一致，从而导致估计精度变差。

## 2. 能观性分析  
### 2.1 状态转移矩阵和观测矩阵  
为了简单起见，能观性分析中不考虑bias，理论上可以证明 $b_a,b_g$是能观的。误差状态变为

$\tilde X = \left[\tilde \theta^T\quad\tilde p^T\quad\tilde v^T\right]^T\\$

旋转误差使用左乘： $\sideset{_G^I}{}{\mathbf{R}} \simeq\left(\mathbf{I}_{3}-\left\lfloor{\tilde{\boldsymbol{\theta}}_{\times}}\right\rfloor\right)\sideset{_G^I}{}{\mathbf{\hat R}}\\$

运动模型：

$\tilde{\mathbf{X}}_{I_{\ell+1 | \ell}} \simeq\mathbf{\Phi}_{I_{\ell}} \tilde{\mathbf{x}}_{I_{\ell | \ell}}+\mathbf{w}_{\ell}\\ \begin{aligned}\mathbf{\Phi}_{I_{\ell}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)&=\left[\begin{array}{ccc}{\hat{\mathbf{R}}_{\ell+1 | \ell} \cdot \hat{\mathbf{R}}_{\ell | \ell}^{T}} & {\mathbf{0}_{3}} & {\mathbf{0}_{3}} \\ {\mathbf{\Phi}_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)} & {\mathbf{I}_{3}} & {\Delta t \mathbf{I}_{3}} \\ {\mathbf{\Phi}_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)} & {\mathbf{0}_{3}} & {\mathbf{I}_{3}}\end{array}\right]\\ \mathbf{\Phi}_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)&=-\left\lfloor\left(^{G} \hat{\mathbf{p}}_{\ell+1 | \ell}-^{G} \hat{\mathbf{p}}_{\ell | \ell}-^{G} \hat{\mathbf{v}}_{\ell | \ell} \Delta t-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t^{2}\right) _\times \right\rfloor \hat{\mathbf{R}}_{\ell | \ell}^{T}\\ \mathbf{\Phi}_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)&=-\left\lfloor\left(^{G} \hat{\mathbf{v}}_{\ell+1 | \ell}-^{G} \hat{\mathbf{v}}_{\ell | \ell} +\sideset{^G}{}{\mathbf{g}} \Delta t\right)_\times\right\rfloor \hat{\mathbf{R}}_{\ell | \ell}^{T}\end{aligned}\\$ 

对于第 $i$个特征在 $\ell$时刻，重投影误差为：

$\begin{aligned} \mathbf{z}_{i, \ell} &=h\left(\sideset{^{C_\ell}}{_{f_i}}{ \mathbf{p}}\right)+\mathbf{n}_{i, \ell} \\ \sideset{^{C_\ell}}{_{f_i}}{ \mathbf{p}} &=\sideset{_{I}^{C}} {}{\mathbf{R}} \mathbf{R}_{\ell}\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^{G}} {_{I_{\ell}}}{\mathbf{p}}\right)+\sideset{^C} {_I}{\mathbf{p}} \end{aligned}\\$ 

观测模型：

$\mathbf{r}_{i, \ell}=\mathbf{H}_{I_{i, \ell}} \tilde{\mathbf{x}}_{I_{\ell | \ell-1}}+\mathbf{H}_{f_{i, \ell}}\sideset{^{G}}{_{f_i}}{\tilde{\mathbf{p}}}+\mathbf{n}_{i, \ell}\\ \begin{aligned}\mathbf{H}_{I_{i, \ell}}&=\mathbf{J}_{i, \ell}\sideset{_I^C}{}{\mathbf{R}}\left[\left\lfloor\hat{\mathbf{R}}_{\ell | \alpha_{i}}\left(\sideset{^{G}}{_{f_i}}{\hat{\mathbf{p}}}-\sideset{^{G}}{_{\ell | \alpha_{i}}}{\hat{\mathbf{p}}}\right)_ \times\right\rfloor\quad-\hat{\mathbf{R}}_{\ell | \alpha_{i}}\quad \mathbf{0}_{3}\right]\\ \mathbf{H}_{f_{i, \ell}}&=\mathbf{J}_{i, \ell}\sideset{_{I}^{C}}{}{\mathbf{R}} \hat{\mathbf{R}}_{\ell | \alpha_{i}}\\ \mathbf{J}_{i, \ell}&=\frac{1}{\sideset{^{C_{\ell}}}{_{f_i}}{\hat{z}}}\left[\begin{array}{ccc}{1} & {0} & {-\frac{\sideset{^{C_{\ell}}}{_{f_i}}{\hat{x}}}{\sideset{^{C_{\ell}}}{_{f_i}}{\hat{z}}}} \\ {0} & {1} & {-\frac{\sideset{^{C_{\ell}}}{_{f_i}}{\hat{y}}}{\sideset{^{C_{\ell}}}{_{f_i}}{\hat{z}}}}\end{array}\right]\end{aligned}\\$ 

### 2.2 能观性阵结构  
论文中以EKF-SLAM系统来计算能观性，应该是为了推导简单，EKF-SLAM与MSCKF都是基于相同的离散线性化模型，且两种方法的推导都是基于IMU误差状态转移模型和重投影残差观测模型，但是用的不同的估计量。因此，如果MSCKF和EKF-SLAM使用相同的线性化点，它们的实现也就基于相同的线性化模型，从而获取到的信息和能观性应该也是相同的。

EKF-SLAM状态向量为：

$X=\left[\sideset{_G^I}{^T}{\bar {\mathbf{q}}}\quad\sideset{^G}{^T}{\mathbf p}\quad\sideset{^G}{^T}{\mathbf v}\quad\sideset{^G}{_1^T}{\mathbf p}\quad...\quad\sideset{^G}{_N^T}{\mathbf p}\right]^T\\$

包含 $[k,k+m]$时间段内的IMU姿态、位置、速度以及 $N$个特征点。在 $\ell\in[k,k+m]$时刻第 $i$个特征点被相机看到，则观测Jacobian为：

$\mathbf{H}_\ell=\left[\begin{matrix}\mathbf{H}_\ell^{(1)}\\\mathbf{H}_\ell^{(2)}\\\vdots\\\mathbf{H}_\ell^{(n_\ell)}\end{matrix}\right]\\\mathbf{H}_\ell^{(i)}=\left[\mathbf{H}_{I_{i,\ell}}\quad \mathbf{0}_3\quad...\quad\mathbf{H}_{f_{i,\ell}}\quad...\quad \mathbf{0}_3\right], i=1,...,n_\ell\\$

注意： $\mathbf{H}_\ell$是由 $n_\ell$个 $\mathbf{H}_\ell^{(i)}$按行堆叠起来，为了简单起见，推导能观性阵时只推导单个Block $\mathcal O_\ell^{(i)}$，完整的能观性阵也是由 $n_\ell$个 $\mathcal O_\ell^{(i)}$按行堆叠起来的。每个Block对应特征点位置有 $\mathbf{H}_{f_{i,\ell}}$，其他特征点位置为0。

将2.1中推导的观测模型带入能观性阵公式中，得到能观性阵为：

$\mathcal{O}_\ell=\left[\begin{matrix}\mathcal{O}_\ell^{(1)}\\\mathcal{O}_\ell^{(2)}\\\vdots\\\mathcal{O}_\ell^{(n_\ell)}\end{matrix}\right]\\ \begin{aligned}\mathcal{O}_{\ell}^{(i)} &=\mathbf{M}_{\ell}^{(i)}\left[\mathbf{A}_{\ell}^{(i)} \mathbf{\Phi}_{I_{\ell-1}} \cdots \mathbf{\Phi}_{I_{k}} \quad \mathbf{0}_{3} \quad \cdots \quad \mathbf{I}_{3} \quad \cdots \quad \mathbf{0}_{3}\right] \\ \mathbf{M}_{\ell}^{(i)} &=\mathbf{J}_{i, \ell} \sideset{^C_I}{}{\mathbf{R}} \hat{\mathbf{R}}_{\ell | \alpha_{i}} \\ \mathbf{A}_{\ell}^{(i)} &=\left[\left\lfloor\sideset{^G}{_{f_i}}{\hat{\mathbf{p}}}-\sideset{^G}{_{\ell | \alpha_{i}}}{\hat{\mathbf{p}}} \times \right\rfloor \hat{\mathbf{R}}_{\ell | \alpha_{i}}^{T} \quad-\mathbf{I}_{3} \quad \mathbf{0}_{3}\right]\end{aligned}\\$

注意：这里套用了叉乘性质 $\left\lfloor\hat{\mathbf{R}}_{\ell | \alpha_{i}}\left(\sideset{^{G}}{_{f_i}}{\hat{\mathbf{p}}}-\sideset{^{G}}{_{\ell | \alpha_{i}}}{\hat{\mathbf{p}}}\right)_ \times\right\rfloor=\hat{\mathbf{R}}_{\ell | \alpha_{i}}\left\lfloor\left(\sideset{^{G}}{_{f_i}}{\hat{\mathbf{p}}}-\sideset{^{G}}{_{\ell | \alpha_{i}}}{\hat{\mathbf{p}}}\right)_ \times\right\rfloor\hat{\mathbf{R}}_{\ell | \alpha_{i}}^T$

### 2.3 能观性维度分析  
能观性分析其实就是判断能观性阵 $\mathcal O_\ell$的维度，或者是其零空间 $\mathbf N$的维度。Li Mingyang的论文都是先直接定义出一个零空间 $\mathbf N$，然后讨论零空间的秩。但严格来说，需要证明 $\mathcal O_\ell$的零空间维度，试凑并不能保证找到了全部的零空间，这个在文献[3]的附录C中有证明。

能观性论文基本都会分别讨论理想(Ideal)Jacobian和实际(Actual)Jacobian的零空间维度，为什么会有两种Jacobian呢？这是因为计算能观性阵时，状态转移矩阵和观测矩阵的Jacobian中包含状态量的估计值，在计算Jacobian时，使用不同的估计值相当于在不同的点进行线性化。最理想的情况是使用状态的真实值来计算Jacobian，但实际只能使用估计值，而使用不同估计值计算出的Jacobian，其能观性维度也不一样，这就是后面能观性改进(FEJ)要做的事情。

### a) 理想Jacobian的能观性维度  
理想Jacobian是将Jacobian中所有的估计值用真实值替代，即 $\hat {\mathbf R}=\mathbf R_k，\sideset{^G}{}{\hat{\mathbf p}}=\sideset{^G}{_k}{\mathbf p}，\sideset{^G}{}{\hat{\mathbf v}}=\sideset{^G}{_k}{\mathbf v}$

计算能观性矩阵结果如下（具体推导见附录A）：

$\begin{aligned}\check{\mathcal{O}}_{\ell}^{(i)}&=\check{\mathbf{M}}_{\ell}^{(i)}\left[\check{\mathbf{\Gamma}}_{\ell}^{(i)} \quad-\mathbf{I}_{3} \quad-\Delta t_{\ell} \mathbf{I}_{3} \quad \mathbf{0}_{3} \quad \cdots \quad \mathbf{I}_{3} \quad \cdots \quad \mathbf{0}_{3}\right]\\ \check{\Gamma}_{\ell}^{(i)}&=\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} \Delta t_{\ell}-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t_{\ell}^{2}\right)_\times\right\rfloor \mathbf{R}_{k}^{T}\end{aligned}\\$ 

构建零空间：

$\mathbf{N}=\left[\begin{matrix}\mathbf 0_3&\mathbf R_k\sideset{^G}{}{\mathbf g}\\ \mathbf I_3&-\left\lfloor{\sideset{^G}{_k}{\mathbf p}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}\\ \mathbf 0_3&-\left\lfloor{\sideset{^G}{_k}{\mathbf v}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}\\ \mathbf I_3&-\left\lfloor{\sideset{^G}{_{f_1}}{\mathbf p}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}\\ \vdots&\vdots\\ \mathbf I_3&-\left\lfloor{\sideset{^G}{_{f_N}}{\mathbf p}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}\\ \end{matrix}\right]\\$ 

很容易看出（带进去算一下）对于任意 $i$和 $\ell$都满足：

$\begin{aligned}\check{\mathcal{O}}_{\ell}^{(i)}\cdot \mathbf N&=\left[-\mathbf I_3+\mathbf I_3\quad\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} \Delta t_{\ell}-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t_{\ell}^{2}\right)_\times\right\rfloor\mathbf R_k^T\mathbf R_k\sideset{^G}{}{\mathbf g}+\left\lfloor{\sideset{^G}{_k}{\mathbf p}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}+\left\lfloor{\sideset{^G}{_k}{\mathbf v}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}\Delta t_\ell-\left\lfloor{\sideset{^G}{_{f_i}}{\mathbf p}}_\times\right\rfloor\sideset{^G}{}{\mathbf g}\right]\\ &=\left[\mathbf0_3\quad\frac12\Delta t_\ell^2\lfloor{\sideset{^G}{}{\mathbf g}}_\times\rfloor\sideset{^G}{}{\mathbf g}\right]=\mathbf 0_{2\times4}\end{aligned}\\$ 

所以 $\check{\mathcal{O}}\cdot \mathbf N=\mathbf 0$，从而证明 $\mathbf N$是 $\check{\mathcal{O}}$的零空间(nullspace)。文献[3]证明 $\check{\mathcal{O}}$的零空间维度是4，而 $rank(\mathbf N)=4$，故 $\mathbf N$是全部零空间。文献[3]证明了零空间 $\mathbf N$的前面3列对应了全局位置，最后一列对应了绕重力轴方向的旋转。综上，在使用理想Jacobian的情况下，能观性阵零空间的维度为4，全局位置和绕重力轴方向的旋转不能观，这与真实系统是一致的。

### b) 实际Jacobian的能观性维度  
在实际MSCKF中，获取不到状态的真实值，只能使用滤波器最新的状态估计值来计算Jacobian，从而计算出的能观性矩阵为（这部分计算太繁琐了，本文不再展开）：

$\begin{aligned}\mathcal{O}_{\ell}^{(i)}=&\mathbf{M}_{\ell}^{(i)}\left[\mathbf{\Gamma}_{\ell}^{(i)}+\Delta \mathbf{\Gamma}_{\ell}^{(i)} \quad-\mathbf{I}_{3} \quad-\Delta t_{\ell} \mathbf{I}_{3} \quad \mathbf{0}_{3} \quad \cdots \quad \mathbf{I}_{3} \quad \cdots \quad \mathbf{0}_{3}\right]\\ \mathbf{\Gamma}_{\ell}^{(i)}=&\left\lfloor\sideset{^G}{_{f_i}}{\hat{\mathbf{p}}}-\sideset{^G}{_{k | k}}{\hat{\mathbf{p}}}-\sideset{^G}{_{k | k}}{\hat{\mathbf{v}}} \Delta t_{\ell}-\frac{1}{2}\sideset{^G}{}{\mathbf{g}}\Delta t_{\ell}^{2} \times\right\rfloor \hat{\mathbf{R}}_{k | k}^{T}\\ \Delta \boldsymbol{\Gamma}_{\ell}^{(i)}=&\left(\left\lfloor^{G} \hat{\mathbf{p}}_{f_{i}}-^{G} \hat{\mathbf{p}}_{\ell | \alpha_{i}} \times\right\rfloor \overline{\mathbf{E}}_{\mathbf{q}}+\overline{\mathbf{E}}_{\mathbf{p}}+\sum_{j=k+1}^{\ell-1}\left(\sum_{s=k+1}^{j} \mathbf{E}_{\mathbf{v}}^{s} \Delta t+\mathbf{E}_{\mathbf{p}}^{j}+\right.\right.\\ & \sum_{s=k+1}^{j-1} \mathbf{\Phi}_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{s+1 | s}}, \hat{\mathbf{x}}_{I_{s | s}}\right) \hat{\mathbf{R}}_{s | s} \mathbf{E}_{\mathbf{q}}^{s} \Delta t+\mathbf{\Phi}_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{j+1 | j}}, \hat{\mathbf{x}}_{I_{j | j}}\right) \hat{\mathbf{R}}_{j | j} \mathbf{E}_{\mathbf{q}}^{j} ) ) \hat{\mathbf{R}}_{k | k}^{T}\\ \overline{\mathbf{E}}_{\mathbf{q}}=&\mathbf{I}_{3}-\left(\hat{\mathbf{R}}_{\ell | \alpha_{i}}^{T} \hat{\mathbf{R}}_{\ell | \ell-1}\right) \prod_{n=k+1}^{\ell-1}\left(\hat{\mathbf{R}}_{n | n}^{T} \hat{\mathbf{R}}_{n | n-1}\right) \\ \mathbf{E}_{\mathbf{q}}^{j}=&\mathbf{I}_{3}-\prod_{n=k+1}^{j}\left(\hat{\mathbf{R}}_{n | n}^{T} \hat{\mathbf{R}}_{n | n-1}\right) \\ \mathbf{E}_{\mathbf{p}}^{j}=&\left\lfloor^{G} \hat{\mathbf{p}}_{j | j-1}-^{G} \hat{\mathbf{p}}_{j | j} \times\right\rfloor, \overline{\mathbf{E}}_{\mathbf{p}}=\left\lfloor^{G} \hat{\mathbf{p}}_{\ell | \ell-1}-^{G} \hat{\mathbf{p}}_{\ell | \alpha_{i}} \times\right\rfloor\\  \mathbf{E}_{\mathbf{v}}^{j}=&\left\lfloor^{G} \hat{\mathbf{v}}_{j | j-1}-^{G} \hat{\mathbf{v}}_{j | j} \times\right\rfloor \end{aligned}$ 

对比实际Jacobian计算出的能观性阵 $\mathcal{O}_{\ell}^{(i)}$与理想Jacobian的能观性阵 $\check{\mathcal{O}}_\ell^{(i)}$，发现唯一的区别在于 $\mathcal{O}_{\ell}^{(i)}$多了一项 $\Delta \boldsymbol{\Gamma}_{\ell}^{(i)}$，论文中称之为扰动项（disturbance）。由于扰动项的存在，使得理想Jacobian下零空间的最后一列不再满足， $\mathcal{O}$的零空间为 $N=\left[\begin{matrix}\mathbf 0_3&\mathbf I_3&\mathbf 0_3&\mathbf I_3&\dots&\mathbf I_3\end{matrix}\right]^T$，也就是绕重力轴的旋转从不能观变得能观了。

扰动项的公式比较复杂，这里只需要关注到它与状态在不同时刻的估计值有关，即 $\overline{\mathbf{E}}_{\mathbf{q}}，\mathbf{E}_{\mathbf{q}}^{j}，\mathbf{E}_{\mathbf{p}}^{j}，\overline{\mathbf{E}}_{\mathbf{p}}，\mathbf{E}_{\mathbf{v}}^{j}$，如果使用相同的估计值那么这些项就为零了。

## 3. 能观性改进  
能观性改进的目的是：通过调整状态转移矩阵和观测矩阵，使能观性矩阵的零空间维度从3变回4（能观性秩由3变回2），从而保证与真实系统能观性一致，进而提高状态估计的精度。

调整能观性维度有两种做法：

1. MSCKF2.0中是利用FEJ(First Estimate Jacobians)，调整线性化点，使得所有的状态都是用最开始的估计量（保证同一时刻），从而调整能观性维度。
2. OC-EKF（Observability-constrained EKF）利用右零空间（nullspace）显示修改能观性矩阵来强制设置不能观的维度。

### 3.1 MSCKF2.0  
MSCKF2.0主要是利用FEJ来调整不能观维度，但其实分为两步：第一步是将旋转误差由左乘改成右乘，第二步才是FEJ，两步一起才达到了改进能观性的效果。

### a) 旋转误差左乘改为右乘  
$\sideset{_G^I}{}{\mathbf R}\simeq\left(\mathbf I_3-\lfloor{\sideset{^I}{}{\tilde {\theta}}}_\times\rfloor\right)\sideset{_G^I}{}{\hat{\mathbf R}}\quad\Rightarrow\quad\sideset{_G^I}{}{\mathbf R}\simeq\sideset{_G^I}{}{\hat{\mathbf R}}\left(\mathbf I_3-\lfloor{\sideset{^G}{}{\tilde {\theta}}}_\times\rfloor\right)\\$

左乘的叠加量相当于局部坐标系旋转误差，右乘相当于全局坐标系的旋转误差。替换右乘后，新的状态转移矩阵和观测矩阵为（具体推导见文献[3]）：

$\begin{aligned}&\mathbf{\Phi}^*_{I_{\ell}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)=\left[\begin{array}{ccc}\mathbf I_3 & {\mathbf{0}_{3}} & {\mathbf{0}_{3}} \\ {\mathbf{\Phi}^*_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)} & {\mathbf{I}_{3}}&  {\Delta t \mathbf{I}_{3}} \\ {\mathbf{\Phi}^*_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)} & {\mathbf{0}_{3}} & {\mathbf{I}_{3}}\end{array}\right]\\ &\mathbf{\Phi}^*_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)=-\left\lfloor\left(^{G} \hat{\mathbf{p}}_{\ell+1 | \ell}-^{G} \hat{\mathbf{p}}_{\ell | \ell}-^{G} \hat{\mathbf{v}}_{\ell | \ell} \Delta t-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t^{2}\right) _\times \right\rfloor\\ &\mathbf{\Phi}^*_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell}}\right)=-\left\lfloor\left(^{G} \hat{\mathbf{v}}_{\ell+1 | \ell}-^{G} \hat{\mathbf{v}}_{\ell | \ell} +\sideset{^G}{}{\mathbf{g}} \Delta t\right)_\times\right\rfloor\\ &\mathbf{H}^*_{I_{i, \ell}}=\mathbf{M}_{\ell}^{(i)}\left[\left\lfloor\left(^{G} \hat{\mathbf{p}}_{f_{i}}-^{G} \hat{\mathbf{p}}_{\ell | \alpha_{i}}\right) \times\right\rfloor \quad-\mathbf{I}_{3} \quad \mathbf{0}_{3 \times 3}\right]=\mathbf{M}_{\ell}^{(i)} {\mathbf{A}_{\ell}^{(i)}}^*\\ &\mathbf{H}^*_{f_{i, \ell}}=\mathbf{M}_{\ell}^{(i)} \end{aligned}\\$ 

可以看到，通过将左乘改成右乘，使得 $\mathbf \Phi^*_{I_\ell}$和 $\mathbf A^*_\ell$与旋转估计无关，再次计算能观性矩阵如下：

$\begin{aligned} \mathcal{O}_{\ell}^{(i)^{*}}&=\mathbf{M}_{\ell}^{(i)}\left[\mathbf{\Gamma}_{\ell}^{(i)^{*}}+\Delta \mathbf{\Gamma}_{\ell}^{(i)^{*}} \quad-\mathbf{I}_{3} \quad-\Delta t_{\ell} \mathbf{I}_{3} \quad \mathbf{0}_{3} \quad \cdots \quad \mathbf{I}_{3} \quad \cdots \quad \mathbf{0}_{3}\right]\\ \boldsymbol{\Gamma}_{\ell}^{(i)^{\star}} &=\left\lfloor\left(\sideset{^G}{_{f_{i}}}{\hat{\mathbf{p}}}-\sideset{^G}{_{k | k}}{\hat{\mathbf{p}}}-\sideset{^G}{_{k | k}}{\hat{\mathbf{v}}} \Delta t_{\ell}-\frac{1}{2}\sideset{^G}{}{\mathbf{g}} \Delta t_{\ell}^{2}\right)_\times\right\rfloor \\ \Delta \boldsymbol{\Gamma}_{\ell}^{(i)^{\star}} &=\overline{\mathbf{E}}_{\mathbf{p}}+\sum_{j=k+1}^{\ell-1}\left(\mathbf{E}_{\mathbf{p}}^{j}+\sum_{s=k+1}^{j} \mathbf{E}_{\mathbf{v}}^{s} \Delta t\right) \end{aligned}\\$ 

此时，扰动项中旋转相关的 $\overline{\mathbf{E}}_{\mathbf{q}}，\mathbf{E}_{\mathbf{q}}^{j}$已经没有了，只剩下 $\mathbf{E}_{\mathbf{p}}^{j}，\overline{\mathbf{E}}_{\mathbf{p}}，\mathbf{E}_{\mathbf{v}}^{j}$。

### b) First-Estimate Jacobian  
$\mathbf{E}_{\mathbf{p}}^{j}，\overline{\mathbf{E}}_{\mathbf{p}}，\mathbf{E}_{\mathbf{v}}^{j}$是由于Jacobian计算过程中使用了不同时刻的估计值，如果能够确保使用相同时刻的估计值，扰动项也就不存在了。所以Jacobian计算中所有状态估计量都使用其第一次的估计值，即用 $\hat X_{I_{\ell|\ell-1}}$替换掉 $\hat X_{I_{\ell|\ell}}$，前者是状态转移得到的首次估计，后者是观测更新后的估计。

FEJ的状态转移矩阵和观测矩阵为：

$\begin{aligned}&\mathbf{\Phi}^*_{I_{\ell}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell-1}}\right)=\left[\begin{array}{ccc}\mathbf I_3 & {\mathbf{0}_{3}} & {\mathbf{0}_{3}} \\ {\mathbf{\Phi}^*_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell-1}}\right)} & {\mathbf{I}_{3}} & {\Delta t \mathbf{I}_{3}} \\ {\mathbf{\Phi}^*_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell-1}}\right)} & {\mathbf{0}_{3}} & {\mathbf{I}_{3}}\end{array}\right]\\ &\mathbf{\Phi}^*_{\mathbf{p q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell-1}}\right)=-\left\lfloor\left(^{G} \hat{\mathbf{p}}_{\ell+1 | \ell}-^{G} \hat{\mathbf{p}}_{\ell | \ell-1}-^{G} \hat{\mathbf{v}}_{\ell | \ell-1} \Delta t-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t^{2}\right) _\times \right\rfloor\\ &\mathbf{\Phi}^*_{\mathbf{v q}}\left(\hat{\mathbf{x}}_{I_{\ell+1 | \ell}}, \hat{\mathbf{x}}_{I_{\ell | \ell-1}}\right)=-\left\lfloor\left(^{G} \hat{\mathbf{v}}_{\ell+1 | \ell}-^{G} \hat{\mathbf{v}}_{\ell | \ell-1} +\sideset{^G}{}{\mathbf{g}} \Delta t\right)_\times\right\rfloor\\ &\mathbf{H}^*_{I_{i, \ell}}=\mathbf{M}_{\ell}^{(i)}\left[\left\lfloor\left(\sideset{^G}{_{f_{i}}}{\hat{\mathbf{p}}}-\sideset{^G}{_{\ell | \ell-1}}{\hat{\mathbf{p}}}\right)_\times\right\rfloor \quad-\mathbf{I}_{3} \quad \mathbf{0}_{3 \times 3}\right]\\ &\mathbf{H}^*_{f_{i, \ell}}=\mathbf{M}_{\ell}^{(i)} \end{aligned}\\$ 

### 3.2 OC-EKF  
OC-EKF的思路是通过调整状态转移矩阵 $\mathbf \Phi$和观测矩阵 $\mathbf H$来修改零空间的维度，S-MSCKF中使用的就是OC-EKF，这一部分暂时理解得不是很透彻。可以看参考文献[6][7][8]。

## 4. 总结  
能观性分析这块理论相对比较复杂，公式比较多，容易看得云里雾里，下面是一些个人的理解：

1. **什么是能观性分析？**能观性分析通过计算能观性矩阵，分析它的零空间的秩，来分析系统哪些状态维度可观/不可观。能观性矩阵对应系统可观测的维度，零空间对应系统不可观的维度。
2. **为什么要做能观性分析？**真实VIO系统不能观的维度是4（位置和yaw角），而实际MSCKF不能观的维度变成了3，绕重力轴的旋转（yaw角）被错误地能观了，从而产生了不一致性（Inconsistency），系统误认为yaw角具有更多的信息从而将yaw对应的协方差设得比较小（Under Estimate），最终导致VIO估计精度的下降。能观性分析就是为了能让MSCKF系统不可观的维度与真实系统一致，从而提高VIO精度。
3. **为什么yaw被错误地能观了？**计算能观性矩阵会用到状态转移矩阵 $\mathbf\Phi$和观测矩阵 $\mathbf H$，这两个Jacobian的计算依赖状态值。如果使用状态真实值计算Jacobian，系统不能观维度为4，与真实系统一致；如果使用状态估计值，由于使用了不同时刻的估计量，能观性阵中会出现一个扰动项 $\Delta \Gamma$，扰动项的存在使得yaw角对应那一维的零空间向量不再成立，从而导致yaw角被错误地能观了。
4. **如何解决能观性不一致？**能观性不一致的原因是扰动项的存在，而扰动项存在的原因是计算过程中使用了状态在不同时刻的估计值，所以MSCKF2.0解决问题的思路是避免在计算Jacobian过程中使用不同时刻的状态估计值。它先将MSCKF2.0先通过将旋转误差量从左乘换到右乘，将姿态量从 $\mathbf\Phi$和 $\mathbf H$中移除（ $\mathbf H$中并未完全移除），既然Jacobian中都不包含姿态，那自然也不存在使用不同时刻姿态估计的问题，然后，通过FEJ（First Estimation Jacobian）计算Jacobian时，位置、速度统一使用首次估计值（即状态转移后的估计值）。通过两步改动能够消除扰动项，使得yaw重新变回不能观。

虽然能观性分析理论推导非常复杂，但代码改动其实比较简单。MSCKF2.0的改动主要有：

1. 旋转误差量左乘换成右乘，重新推导状态转移Jacobian $\mathbf \Phi$和观测Jacobian $\mathbf H$。
2. 在计算 $\mathbf \Phi$和 $\mathbf H$的过程中，用 $\hat{\mathbf p}_{I_{\ell|\ell-1}},\hat{\mathbf v}_{I_{\ell|\ell-1}}$替换掉 $\hat{\mathbf p}_{I_{\ell|\ell}},\hat{\mathbf v}_{I_{\ell|\ell}}$。

OC-EKF的改动主要有：

1. 在MSCKF计算完 $\mathbf \Phi$和 $\mathbf H$后，根据公式修改 $\mathbf \Phi$和 $\mathbf H$（具体见S-MSCKF代码）。

## 附录  
### A. 理想Jacobian的能观性矩阵推导  
推导一下 $\check{\mathcal{O}}_{\ell}^{(i)}$的前面三项：

$\begin{aligned}\mathbf{A}_\ell^{(i)}\mathbf\Phi_{I_{\ell-1}}...\mathbf\Phi_{I_k}&=\left[\left\lfloor\sideset{^G}{_{f_i}}{\hat{\mathbf{p}}}-\sideset{^G}{_k}{\mathbf{p}} \times \right\rfloor \mathbf{R}_k^T \quad-\mathbf{I}_{3} \quad \mathbf{0}_{3}\right] \left[\begin{array}{ccc}\mathbf I_3& {\mathbf{0}_{3}} & {\mathbf{0}_{3}} \\\left\lfloor\left(^{G} \mathbf{v}_k \Delta t_1+\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t^2_1\right) _\times \right\rfloor \mathbf R_k^T & {\mathbf{I}_{3}} & {\Delta t \mathbf{I}_{3}} \\ \left\lfloor{\sideset{^G}{}{\mathbf g} \Delta t_1}_\times \right\rfloor\mathbf R_k^T & {\mathbf{0}_{3}} & {\mathbf{I}_{3}}\end{array}\right]\mathbf\Phi_{I_{\ell-2}}...\mathbf\Phi_{I_k}\\ &=\left[\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} \Delta t_1-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t_1^2\right)_\times\right\rfloor \mathbf{R}_k^T \quad-\mathbf{I}_{3} \quad -\Delta t_1\mathbf I_3\right]\mathbf\Phi_{I_{\ell-2}}...\mathbf\Phi_{I_k}\\ &=\left[\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} \Delta t_1-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t_1^2\right)_\times\right\rfloor \mathbf{R}_k^T \quad-\mathbf{I}_{3} \quad -\Delta t_1\mathbf I_3\right] \left[\begin{array}{ccc}\mathbf I_3& {\mathbf{0}_{3}} & {\mathbf{0}_{3}} \\\left\lfloor\left(^{G} \mathbf{v}_k \Delta t_2+\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t^2_2\right) _\times \right\rfloor \mathbf R_k^T & {\mathbf{I}_{3}} & {\Delta t \mathbf{I}_{3}} \\ \left\lfloor{\sideset{^G}{}{\mathbf g} \Delta t_2}_\times \right\rfloor\mathbf R_k^T & {\mathbf{0}_{3}} & {\mathbf{I}_{3}}\end{array}\right] \mathbf\Phi_{I_{\ell-3}}...\mathbf\Phi_{I_k}\\ &=\left[\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} \Delta t_1-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t_1^2-\mathbf{v}_k \Delta t_2-\frac{1}{2} \sideset{^G}{}{\mathbf{g}} \Delta t^2_2 - \sideset{^G}{}{\mathbf g} \Delta t_1\Delta t_2\right)_\times\right\rfloor \mathbf{R}_k^T \quad-\mathbf{I}_{3} \quad -\Delta t_1\mathbf I_3\right]\mathbf\Phi_{I_{\ell-2}}...\mathbf\Phi_{I_k}\\ &=\left[\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} (\Delta t_1+\Delta t_2)-\frac{1}{2} \sideset{^G}{}{\mathbf{g}}(\Delta t_1+\Delta t_2)^2\right)_\times\right\rfloor \mathbf{R}_k^T \quad-\mathbf{I}_{3} \quad -(\Delta t_1+\Delta t_2)\mathbf I_3\right]\mathbf\Phi_{I_{\ell-2}}...\mathbf\Phi_{I_k}\\ &=\left[\left\lfloor\left(\sideset{^G}{_{f_i}}{\mathbf{p}}-\sideset{^G}{_k}{\mathbf{p}}-^{G} \mathbf{v}_{k} \Delta t_\ell-\frac{1}{2} \sideset{^G}{}{\mathbf{g}}\Delta t_\ell^2\right)_\times\right\rfloor \mathbf{R}_k^T \quad-\mathbf{I}_{3} \quad -\Delta t_\ell\mathbf I_3\right] \end{aligned}\\$ 

注意到后面不断迭代乘以 $\mathbf \Phi$， $\mathbf{A}_\ell^{(i)}\mathbf\Phi_{I_{\ell-1}}...\mathbf\Phi_{I_k}$的形式保持不变，只是 $\Delta t_\ell$（ $k$到 $\ell$的时间间隔）的区别。

## 参考文献  
1. E. Jones and S. Soatto, “Visual-inertial navigation, mapping and localization: A scalable real-time causal approach,” International Journal of Robotics Research, vol. 30, no. 4, pp. 407–430, Apr. 2011.
2. J. Kelly and G. Sukhatme, “Visual-inertial sensor fusion: Localization, mapping and sensor-to-sensor selfcalibration,” International Journal of Robotics Research, vol. 30, no. 1, pp. 56–79, Jan. 2011.
3. M. Li and A. I. Mourikis, “Consistency of EKF-based visual-inertial odometry,” University of California Riverside, Tech. Rep., 2011, [http://www.ee.ucr.edu/»mourikis/tech](http://www.ee.ucr.edu/»mourikis/tech) reports/VIO.pdf.
4. Li, M. and Mourikis, A. I. (2012a). Improving the accuracy of EKF-based visual-inertial odometry. In Proceedings of the IEEE International Conference on Robotics and Automation, pages 828–835, St Paul, MN.
5. Li M , Mourikis A I . High-precision, consistent EKF-based visual-inertial odometry[J]. The International Journal of Robotics Research, 2013, 32(6):690-711.
6. Observability-constrained Vision-aided Inertial Navigation
7. Kottas D G , Hesch J A , Bowman S L , et al. On the Consistency of Vision-Aided Inertial Navigation[J]. 2013.
8. Hesch J A , Kottas D G , Bowman S L , et al. Consistency Analysis and Improvement of Vision-aided Inertial Navigation[J]. IEEE Transactions on Robotics, 2017, 30(1):158-176.

