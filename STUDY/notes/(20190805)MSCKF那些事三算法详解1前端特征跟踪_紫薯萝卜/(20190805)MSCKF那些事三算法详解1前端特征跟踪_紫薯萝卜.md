# MSCKF那些事（三）算法详解1：前端特征跟踪

 **Author:** [紫薯萝卜]

 **Link:** [https://zhuanlan.zhihu.com/p/76375967]

VIO算法的核心在后端，不管是优化的方法还是滤波的方法，都是靠后端的紧耦合融合获得较高的VIO精度，为了节省计算量一般前端都会做得很简单，基本都是FAST、Harris等角点加LK光流跟踪（S-MSCKF中使用的FAST角点，VINS\_MONO中使用的goodFeatureToTrack）。如果计算资源充裕的话，也可以换成ORB、SURF、SIFT等描述子特征，精度应该会有所提升。

这里以S-MSCKF中的双目特征跟踪为例进行介绍，单目特征跟踪步骤很类似，可以参照[https://github.com/HKUST-Aerial-Robotics/VINS-Mono](https://github.com/HKUST-Aerial-Robotics/VINS-Mono)中的前端实现。

### 1. 特征跟踪流程  
S-MSCKF前端主要步骤：

* **A. 双目特征跟踪**
+ **a) 左图前后帧跟踪**：对上一帧左图特征点，在当前帧左图进行跟踪，获得当前帧左图的跟踪特征点
+ **b) 左右图跟踪**：对当前帧左图特征点，在当前帧右图进行跟踪，获得当前帧右图的跟踪特征点
+ **c) 左右图前后帧RANSAC**：分别对左右图，进行前后帧2-points RANSAC，剔除外点。只保留左右目都通过RANSAC的特征点。

* **B. 双目特征新增**
+ **a) 提取左图特征**：在当前帧左图上，构建mask，已有特征附近不提取，在图像剩下区域提取FAST角点，将新的角点投射到网格中，如果网格中特征点满了则删除该新角点。
+ **b) 左右图跟踪**：对当前帧左图新提取的特征点，在当前帧右图进行跟踪，获得当前帧右图的跟踪特征点

* **C. 特征均匀化采样**
+ 为了使得特征点均匀分布在图像上，将图像分成了4\*5个网格(grid)，每个网格中最多4个特征点，这样避免了特征点集中在图像上的某一小块。跟踪的特征点可能会使得单个网格中的特征点数量超过限制，需要对网格特征点进行修剪，修剪的原则是尽量保留生存时间（特征点被跟踪的帧数）较长的特征点。

这里实现时需要注意的细节是左右图的特征点是成对出现的，所以对于那些在右图中跟踪失败的点，在左图特征点会被删除。

特征跟踪流程中的跟踪主要有两种：前后帧跟踪和左右图跟踪，二者都是调用LK光流。区别在于前后帧跟踪用了IMU估计相机旋转来预测特征点初值，左右图跟踪用的相机外参，而且左右图跟踪还加了极线约束，所以左右图匹配准确性更高。

### 2. 前后帧跟踪  
* **A. IMU旋转估计**

收集前后两帧之间所有的IMU数据，计算平均角速度 $\omega_{\text{imu}}$，通过外参分别转到左右相机系，再乘以时间得到相对旋转： 
$$
\begin{aligned}
\bar{\omega}_{\text{imu}}&=\frac{1}{N} \sum_{j=1}^N \omega_j \\
\omega_{\text{cam}_0}&=^{cam_0}_{imu}R\bar{\omega}_{\text{imu}}, \quad \delta R_{\text{cam}_0} =\omega_{\text{cam}_0}\delta t \\
\omega_{\text{cam}_1}&=^{cam_1}_{imu}R\bar{\omega}_{\text{imu}}, \quad \delta R_{\text{cam}_1} =\omega_{\text{cam}_1}\delta t
\end{aligned}
$$

* **B. 特征点预测**

对于前一帧特征点 $p_p$，投影到后一帧为

$$
sp_c=K\cdot (\delta R\cdot d \cdot K^{-1}p_p + \delta t)
$$

$s$ 为尺度， $d$ 为特征点深度， $d$ 和 $\delta t$ 未知，直接令 $d=1,\delta t=0$（这样做肯定会有误差，但这只是预测特征点的初始位置，后面会有LK光流来对位置进行refine）因为假设所有特征点都在深度为1的normalize平面，所以可以直接计算Homography， $H=K\cdot\delta R\cdot K^{-1}$，从而投影公式简化为 

$$
sp_c=Hp_p
$$

* **C. LK光流跟踪**

调用opencv中的calcOpticalFlowPyrLK进行跟踪。

### 3. 左右图跟踪  
* **A. 特征点预测**

由于特征点深度未知，同样假设特征点在normalize平面，计算 $H=K_{\text{cam}_1}\cdot R_{\text{cam}_0\rightarrow \text{cam}_1}\cdot K_{\text{cam}_0}^{-1}$。这里还考虑了图像畸变参数，所以会预测得更准一点。具体实现上就是先调用undistortPoints()转到normalized平面，再乘以旋转矩阵，最后调用distortPoints()投到右相机平面。

* **B. LK光流跟踪**

调用opencv中的calcOpticalFlowPyrLK进行跟踪。

* **C. 极线约束判断**

左右图跟踪中由于 $R,t$ 已知，所以可以计算Essential Matrix $E=\lfloor t_{\times}\rfloor R$，对于左右图特征点先undistort到normalized平面 $p_{n_0},p_{n_1}$，然后根据极线约束 $p_{n_1}^TEp_{n_0}=0$，将不满足极线约束的特征删除。

### 4. 2-point RANSAC  
设前后两帧的特征点匹配对为 $\{<\bar{p}_{p_i}, \bar{p}_{c_i}>\}_{i=1,2,...,N}$，特征都已经转到了各自相机的normalize平面，则有极线约束

$$
\bar{p}_c^T \ \lfloor \underbrace{\delta t_{\times}\rfloor\delta R}_E\ \bar{p}_p = 0
$$

根据叉乘性质对公式进行变换

$$
\bar{p}_c^T \lfloor \delta t_{\times}\rfloor\delta R\bar{p}_p =-\bar{p}_c^T \lfloor{\delta R\bar{p}_p}_{\times}\rfloor \delta t=( \lfloor{\delta R\bar{p}_p}_{\times}\rfloor\bar{p}_c)^T\delta t = (\delta R\bar{p}_p \times \bar{p}_c)\cdot \delta t = 0
$$

其中 $\delta R$ 已经通过陀螺仪计算得到，理论上任取3组特征对就能计算出 $\delta t$，但由于 $\delta t$ 尺度未知（单目无法恢复尺度），所以可以令 $\delta t$ 任意一项为1，这样只需要取两组就可以计算 $\delta t$。

上述约束也可以从几何上理解， 下图中 $Rp_1, p_2$ 和 $T$ 共同组成三角形，设三个向量 $a,b,c$ 共面,则有 $(a\times b)\cdot c=0$，因而 $(\delta R\bar{p}_p \times \bar{p}_c)\cdot \delta t = 0$ 

![]((20190805)MSCKF那些事三算法详解1前端特征跟踪_紫薯萝卜/v2-5a0dbb6d7f75f14822976095bf29e6b8_1440w.jpg)  


对极约束的几何意义

  
  
在RANSAC之前先要检测是不是纯旋转运动，因为纯旋转运动极线约束不成立。判断方式很简单：计算所有特征的重投影误差 $e=\delta Rp_p- p_c$，统计平均投影距离 $\bar{|e|}$，平均投影距离很小，则说明是纯旋转，直接根据约束 $\delta Rp_p=p_c$ 来进行外点剔除。

$\delta t$ 的哪一项设为1呢？假设两组特征匹配对构建约束方程如下：

$$
\left(\begin{matrix}a_1&a_2&a_3\\b_1&b_2&b_3\end{matrix}\right)\left(\begin{matrix}t_x\\t_y\\t_z\end{matrix}\right)=0
$$

设 $t_x=1$，则有

$$
\left(\begin{matrix}a_2&a_3\\b_2&b_3\end{matrix}\right)\left(\begin{matrix}t_y\\t_z\end{matrix}\right)=\left(\begin{matrix}a_1\\b_1\end{matrix}\right)
$$

设 $t_y=1$ 或 $t_z=1$ 同理。S-MSCKF中选择 $(a_1,b_1),(a_2,b_2),(a_3,b_3)$ 中最小一范数的那一维对应项设为1。 

