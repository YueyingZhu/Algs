# MSCKF那些事（四）算法详解2：数学基础

 **Author:** [紫薯萝卜]

 **Link:** [https://zhuanlan.zhihu.com/p/76793847]

**1. 数学定义**

后续将进行MSCKF数学基础介绍，先总结一下数据符号定义。

* 坐标系定义
+ { $G$}：世界坐标系，地面(ground)系，有的论文也写作{ $W$}世界(world)系，通常定义为算法初始化时刻的机器人的“前右下”坐标系或者“北东地”坐标系。
+ { $I$}：IMU坐标系，IMU加速度计、角速度计的测量坐标系。
+ { $B$}：Body系，通常是机器人”前右下”坐标系，MSCKF中通常将{ $B$}系定义为{ $I$}系。
+ { $C$}：Camera系，因为有历史多个相机状态，所以通常有下标{ $C_i$}表示第i个。

* 物理量定义
+ $\sideset{^B_A}{}q$：单位四元数，表示A系到B系的旋转，长度为4
+ $\sideset{^B_A}{}{\tilde\theta}$：旋转的误差量表示，所以通常会带波浪号上标，长度为3
+ $\sideset{^A}{}{v_B}$：A坐标系下B的速度
+ $\sideset{^A}{}{p_B}$：A坐标系下B的位置
+ $b_a,b_g$：加速机和陀螺仪的bias

* 估计量定义： $\tilde x$表示误差值， $\hat x$表示估计值， $x$没有上标表示真实值。 $\tilde x=x-\hat x， x =\hat x +\tilde x\\$
* 传感器观测量用右下标m表示： $a_m, \omega_m$，分别表示从加速度计和陀螺仪获得的测量加速度和测量角速度

$\omega_m = \omega+b_g+n_g\\ a_m = \sideset{^I_G}{}R(\sideset{^G}{_I}a-\sideset{^G}{}g)+b_a+n_a$ 

* 四元数定义：四元数有Hamilton和JPL两种形式，不同论文定义不一致，后面统一使用的JPL形式，区别如下

![]((20200221)MSCKF那些事四算法详解2数学基础_紫薯萝卜/v2-40c39ce7d1a72c612e9bc131c5cf7e1c_1440w.jpg)  


两种形式的四元数对比

  
  
* 旋转的表示： $q$表示四元数， $R$表示旋转矩阵， ${\tilde\theta}$表示旋转误差量，有时也写成 $\delta \theta$。 $q$和 $R$之间的相互转换可以参见[https://en.wikipedia.org/wiki/Quaternions\_and\_spatial\_rotation](https://en.wikipedia.org/wiki/Quaternions\_and\_spatial\_rotation), $\delta R=I-\lfloor \delta \theta{\times}\rfloor  ，\lfloor {\times}\rfloor$ 为反对称矩阵。
* $\delta \theta$量的左乘与右乘：对于一个旋转矩阵 $R$，其误差量 $\delta R$，则左乘定义为 $R=\delta R \cdot\hat R$, 右乘定义为 $R= \hat R\cdot\delta R$。不同论文的定义不一样，所以可能推导出的Jacobian也不一样。 后面统一使用左乘定义。

## 2. 误差状态向量  
MSCKF后端的融合框架用的error-state EKF，其状态向量包括：IMU状态和N个历史相机状态，误差状态向量如下：

$\tilde X_{IMU}=\left[\begin{matrix}\delta \theta_I^T&  \tilde b_g^T&  \sideset{^G}{^T_I}{\tilde v} & {\tilde b_a}^T& \sideset{^G}{^T_I}{\tilde p}\end{matrix}\right]^T\\$

这里波浪号代表误差量，除了旋转量以外，其他误差项都是直接相加(真实值=估计值+误差值)，旋转量的误差项的叠加方式为：

$q=\delta q\bigotimes \hat q\\ \delta q\approx\left(\frac12\sideset{^G_I}{^T}{\delta \theta} \ \ 1\right)^T$ 

由于 $q$的维度为4， $\delta q$的维度为3，所以状态向量 $X_{IMU}$长度为16，而误差状态向量 $\tilde X_{IMU}$的长度为15。 $k$时刻的完整状态向量 $X_k$如下，维度为 $15+6N$， $N$为相机个数：

$\tilde X_k=\left[\begin{matrix}\tilde X_{IMU_k}^T&\delta \theta_{C_1}^T&\sideset{^G}{^T_{C_1}}{\tilde p}&...&&\delta \theta_{C_N}^T&\sideset{^G}{^T_{C_N}}{\tilde p}\end{matrix}\right]^T\\$

状态协方差矩阵为：

$P_{k | k}=\left[\begin{array}{cc}{P_{I I_{k | k}}} & {P_{I C_{k | k}}} \\ {P_{I C_{k | k}}^{T}} & {P_{C C_{k | k}}}\end{array}\right]\\$

其中 $P_{I I_{k | k}}$是 $15\times15$的IMU状态对应协方差， $P_{C C_{k | k}}$是 $6N\times6N$的相机状态对应的协方差， $P_{I C_{k | k}}$是IMU状态与相机状态之间的关联协方差。

*注意：这里的只讨论了最基本的15维IMU状态，很多论文为了获得更高的精度，会将状态向量扩展到更高维，如将相机内外参、时间同步误差等状态量加入到状态向量中，在后续篇章中会进行单独介绍。*

## 3.Error-State EKF  
先回顾EKF(Extendec Kalman Filter)：

* 非线性模型：

$x_k=f(x_{k-1},u_k)+w_k\\z_k=h(x_k)+v_k$

其中 $w_k\sim N(0,Q_k)，v_k\sim N(0,R_k)$。

* EKF预测：

$\hat x_{k|k-1}=f(\hat x_{k-1|k-1},u_k)\\P_{k|k-1}=F_kP_{k-1|k-1}F_k^T+Q_k$

* EKF更新：

$K_k=P_{k|k-1}H_k^T(H_kP_{k|k-1}H_k^T+R_k)^{-1}\\ \hat x_{k|k}=\hat x_{k|k-1}+K_k(z_k-h(\hat x_{k|k-1}))\\ P_{k|k}=(I-K_kH_k)P_{k|k-1}$ 

  
协方差更新有三种等价形式[2]：

1. $P\leftarrow(I-KH)P$：常规版本，数值稳定性较差，计算出的协方差不能保证是对称正定阵。
2. $P\leftarrow P- K(HPH^T+R)K^T$：对称形式，计算出的协方差仍是对称阵。
3. $P\leftarrow (I-KH)P(I-KH)^T+KRK^T$：对称正定形式，计算出的协方差是仍是对称正定阵。

可以推导出3种形式是相等的，推导如下：

$\begin{aligned}K=PH^T(HPH^T+R)^{-1}&\Rightarrow K(HPH^T+R)=PH^T\\P-K(HPH^T+R)K^T&=P-PH^TK^T\\&=P^T-KHP^T \\&=(I-KH)P\\(I-KH)P(I-KH)^T+KRK^T&=(I-KH)P-(I-KH)PH^TK^T+KRK^T\\&=(I-KH)P-PH^TK^T+K(HPH^T+R)K^T\\&=(I-KH)P-PH^TK^T+PH^TK^T\end{aligned}$ 

MSCKF中用的ESKF(Error-State Kalman Filter)，为什么要用ESKF而不是EKF呢? 参考文献[2]中解释了几点理由, 翻译过来大体是：

![]((20200221)MSCKF那些事四算法详解2数学基础_紫薯萝卜/v2-aa015ac341149755b380c564679e4b06_1440w.jpg)  


Error-State KF相比EKF的优势

  
  
* 朝向(姿态)的误差状态是最小参数描述, 避免了冗余参数化导致协方差矩阵奇异;
* 误差状态系统通常在原点附近, 参数远离奇异点或万向节锁等问题, 从而确保EKF线性化一直有效;
* 误差状态通常很小, 意味着二阶项可以忽略. 这使得Jacobian能够快速容易计算;
* 误差状态的动态变化较慢, 这是因为大的信号动态性被积分到了额定状态. 这意味着EKF更新频率可以比预测频率低.*(VIO中通常IMU数据频率为100-500HZ, 而图像频率只有20-30HZ左右)*

MSCKF中的运动模型和观测模型如下：

$\dot {\tilde X}=F\tilde X_{IMU}+Gn_{IMU}\\r=H\tilde X$

运动模型和观测模型都是关于误差状态向量 $\tilde X$的，其中 $F,G,H$是线性化的Jacobian矩阵。需要注意的是，运动模型只与IMU状态有关，相机状态不发生改变，但是相机与IMU状态之间的协方差会发生改变。观测模型其实至于相机状态有关，但会通过协方差同步对IMU状态进行修正。

### MSCKF Propagation/Predict  
MSCKF中状态向量Propagation是利用IMU数值积分对原IMU状态（而不是误差状态）进行Propagation，数值积分方法有Euler法，Mid-Point法，Runge-Kutta法等。协方差迭代公式为:

$P_{k+1 | k}=\left[\begin{array}{cc}{P_{I I_{k+1 | k}}} & {\Phi\left(t_{k}+T, t_{k}\right) P_{I C_{k | k}}} \\ {P_{I C_{k | k}}^{T} \Phi\left(t_{k}+T, t_{k}\right)^{T}} & {P_{C C_{k | k}}}\end{array}\right]\\$

其中 $\Phi(t_{k}+T, t_{k})$同样根据如下微分方程进行数值积分，初值 $\Phi(t_k,t_k)=I$

$\dot{\Phi}(t_k+\tau,t_k)=F\Phi(t_k+\tau,t_k)\\$

### MSCKF Update  
MSCKF更新步骤与EKF更新步骤基本类似

$K=PH^T(HPH^T+R)^{-1}\\ \Delta X = Kr\\ P_{k+1|k+1}=(I-KH)P_{k+1|k}(I-KH)^T+KRK^T$ 

与常规EKF更新公式唯一的区别在状态向量更新量直接是 $Kr$，协方差更新公式使用的对称正定式版本。有了MSCKF的预测和更新步骤，后面我们需要做得就是将运动模型和观测模型推导出来，其实就是求 $F,G,H$这几个Jacobian矩阵，然后套用EKF公式迭代计算状态向量及其对应的协方差。

## 参考文献  
1. [http://mars.cs.umn.edu/tr/reports/Trawny05b.pdf](http://mars.cs.umn.edu/tr/reports/Trawny05b.pdf)
2. [http://www.iri.upc.edu/people/jsola/JoanSola/objectes/notes/kinematics.pdf](http://www.iri.upc.edu/people/jsola/JoanSola/objectes/notes/kinematics.pdf)
3. Mourikis A I, Roumeliotis S I. A Multi-State Constraint Kalman Filter for Vision-aided Inertial Navigation[C]// IEEE International Conference on Robotics and Automation. IEEE, 2007:3565-3572
