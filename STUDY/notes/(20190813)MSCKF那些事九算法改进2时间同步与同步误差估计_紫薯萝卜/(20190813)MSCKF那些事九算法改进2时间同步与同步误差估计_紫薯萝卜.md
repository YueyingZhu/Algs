# MSCKF那些事（九）算法改进2：时间同步与同步误差估计

 **Author:** [紫薯萝卜]

 **Link:** [https://zhuanlan.zhihu.com/p/77996744]

**1. 同步误差 $t_d$定义**

不同传感器之间的数据同步对融合算法至关重要，在VIO中，相机与IMU之间的数据同步对VIO精度影响非常大。如下图所示，假设相机和IMU在同一时刻（设为 $t_0$）采样，由于曝光、数据传输等需要时间，相机数据在 $t_b$时间后才收到，IMU数据在 $t_a$时间后收到，一般在收到传感器数据后才会打时间戳，所以相机和IMU数据的时间戳分别为 $t_{cam}=t_0+t_b,t_{imu}=t_0+t_a$，由于 $t_a$与 $t_b$的不一致，使得本来在同一时刻采集的相机和IMU数据被打上了不同的时间戳，从而造成了数据不同步，定义同步误差（也叫Time Delay） $t_d=t_a-t_b$，由于我们只关心两者之间的相对时间，所以只需要在图像时间戳上加上 $t_d$来补偿掉图像与IMU之间的误差，IMU时间戳保持不变。

![]((20190813)MSCKF那些事九算法改进2时间同步与同步误差估计_紫薯萝卜/v2-3d36ce368ecd004b3694a88ff7aed915_1440w.jpg)  


VIO同步误差示意图

  
  
## 2.t\_d估计理论推导  
$t_d$通常不是一个恒定的值，所以没法事先标定补偿，需要加入到状态向量中进行实时估计（Online Temporal Calibration）。加入 $t_d$后最主要的改动就是State Augmentation：**当图像在 $t$时刻采集，需要将 $t+t_d$时刻的相机状态加入到状态向量中，而原始MSCKF加入的是 $t$时刻相机状态。**

先IMU预测到 $t+t_d$时刻（而不是原来的 $t$时刻），再根据外参计算 $t+t_d$时刻相机位姿并扩展到状态向量：

$$
\mathbf{\hat{c}}_{\text{new}}=\left[\begin{matrix}^{C}_{G}{\hat{\mathbf{q}}}(t+t_d)\\^{G}_{C}{\hat{\mathbf{p}}}(t+t_d)\end{matrix}\right]=\left[\begin{matrix}^{I}_{C}{\mathbf{\hat{q}}}\otimes^{I}_{G}{\mathbf{\hat{q}}}(t+\hat{t}_d)\\ ^{G}_{I}{\mathbf{\hat{p}}}(t+\hat{t}_d)+^{I}_{G}{\mathbf{\hat{R}}}(t+\hat{t}_d)^T^{I}_{C}{\mathbf{\hat{p}}}\end{matrix}\right]
$$ 

最后扩展协方差矩阵：

$$
\mathbf{P}\left(t+\hat{t}_{d}\right) \leftarrow\left[\begin{array}{cc}{\mathbf{P}\left(t+\hat{t}_{d}\right)} & {\mathbf{P}\left(t+\hat{t}_{d}\right) \mathbf{J}_{\text{new}}^{\mathrm{T}}} \\ {\mathbf{J}_{\text{new}} \mathbf{P}\left(t+\hat{t}_{d}\right)} & {\mathbf{J}_{\text{new}} \mathbf{P}\left(t+\hat{t}_{d}\right) \mathbf{J}_{\text{new}}^{\mathrm{T}}}\end{array}\right]\\ 
\mathbf{J}_{\text{new}}=\left[\begin{array}{llll}{\mathbf{J}_{I}} & {\mathbf{J}_{IC}} & {\mathbf{J}_{t}} & {\mathbf{0}}\end{array}\right]
$$ 

$\mathbf{J}_{\text{new}}$ 是 $\hat{\mathbf{c}}_{\text{new}}$ 对状态向量的Jacobian，这里只推导 $\hat{\mathbf{c}}_{\text{new}}$ 对 $t_d$ 的Jacobian $\mathbf{J}_t$，其他项在之前的章节已经推导过了。（**注意：推导的Jacobian和论文[1]中的不一致，这是因为[1]对旋转误差量使用的右乘，而这里统一使用的左乘**）

$$
\mathbf{J}_t=\left[\begin{matrix}\frac{\partial ^{C}_{G}\delta \mathbf{\theta}(t+t_d)}{\partial\tilde{t}_d}\\\frac{\partial ^{G}_{C}{\mathbf{\tilde{p}}}(t+t_d)}{\partial\tilde{t}_d}\end{matrix}\right]=\left[\begin{matrix}^{I}_{C}{\mathbf{\hat{R}}}^{I}{\hat{\omega}(t+\hat{t}_d)}\\^{G}_{I}{\mathbf{\hat{v}}}(t+\hat{t}_d)+^{I}_{G}{\mathbf{\hat{R}}(t+\hat{t}_d)}\left\lfloor{^{I}{\hat{\omega}(t+\hat{t}_d)}}_{\times}\right\rfloor^{I}_{C}{\mathbf{\hat{p}}}\end{matrix}\right]
$$

推导过程如下：

$\begin{aligned}\sideset{_G^C}{}{R(t+t_d)}=&\sideset{_I^C}{}{R}\ \sideset{_G^I}{}{R(t+t_d)}\\ \Rightarrow \left(I-\left\lfloor{\sideset{_G^C}{}{\delta \theta(t+t_d)}}_{\times}\right\rfloor\right)\sideset{_G^C}{}{\hat R(t+t_d)}=&\sideset{_I^C}{}{\hat R}\ \sideset{_G^I}{}{\hat R(t+\hat t_d+\tilde t_d)}\\ =&\sideset{_I^C}{}{\hat R}\left(I-\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\right)\sideset{_G^I}{}{\hat R(t+\hat t_d)}\\ \Rightarrow \left\lfloor{\sideset{_G^C}{}{\delta \theta(t+t_d)}}_{\times}\right\rfloor=&\sideset{_I^C}{}{\hat R}\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\sideset{^I_C}{}{\hat R}=\left\lfloor{\sideset{_I^C}{}{\hat R}\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\\ \Rightarrow \frac{\partial \sideset{_G^C}{}{\delta \theta(t+t_d)}}{\partial\tilde t_d}=&\sideset{_I^C}{}{\hat R}\sideset{^I}{}{\hat\omega(t+\hat t_d)}\end{aligned}\\ \begin{aligned}\\ \sideset{^G}{_C}{p}(t+t_d)=&\sideset{^G}{_I}{p}(t+t_d)+\sideset{_G^I}{^T}{R(t+t_d)}\sideset{^I}{_C}{p}\\ \Rightarrow \sideset{^G}{_C}{\hat p}(t+t_d)+\sideset{^G}{_C}{\tilde p}(t+t_d)=&\sideset{^G}{_I}{\hat p}(t+\hat t_d+\tilde t_d)+\sideset{_G^I}{^T}{\hat R(t+\hat t_d+\tilde t_d)}\sideset{^I}{_C}{\hat p}\\ =&\left(\sideset{^G}{_I}{\hat p}(t+\hat t_d)+\sideset{^G}{_I}{\hat v}(t+\hat t_d)\tilde t_d\right)\\ &\quad +\left(\left(I-\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\right)\sideset{_G^I}{}{\hat R(t+\hat t_d)}\right)^T\sideset{^I}{_C}{\hat p}\\ =&\left(\sideset{^G}{_I}{\hat p}(t+\hat t_d)+\sideset{^G}{_I}{\hat v}(t+\hat t_d)\tilde t_d\right)\\ &\quad +\sideset{_G^I}{^T}{\hat R(t+\hat t_d)}\left(I+\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\right)\sideset{^I}{_C}{\hat p}\\ \Rightarrow \sideset{^G}{_C}{\tilde p}(t+t_d)=&\sideset{^G}{_I}{\hat v}(t+\hat t_d)\tilde t_d+\sideset{_G^I}{}{\hat R(t+\hat t_d)}\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\sideset{^I}{_C}{\hat p}\\ =&\sideset{^G}{_I}{\hat v}(t+\hat t_d)\tilde t_d+\sideset{_G^I}{}{\hat R(t+\hat t_d)}\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}}_{\times}\right\rfloor\sideset{^I}{_C}{\hat p}\tilde t_d\\ \Rightarrow\frac{\partial \sideset{^G}{_C}{\tilde p}(t+t_d)}{\partial\tilde t_d}=&\sideset{^G}{_I}{\hat v}(t+\hat t_d)+\sideset{_G^I}{}{\hat R(t+\hat t_d)}\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}}_{\times}\right\rfloor\sideset{^I}{_C}{\hat p} \end{aligned}\\$ 

上述推导最关键的那一步替换是旋转 $R$和 $p$与 $t_d$之间的关系（旋转对时间的导数是角速度）即：

$\begin{aligned}\sideset{_G^I}{}{\hat R(t+\hat t_d+\tilde t_d)}&=\sideset{_{I(t+\hat t_d)}^{I(t+\hat t_d+\tilde t_d)}}{}{\delta \hat R}\cdot\sideset{_G^I}{}{\hat R(t+\hat t_d)}=\left(I-\left\lfloor{\sideset{^I}{}{\hat\omega(t+\hat t_d)}\tilde t_d}_{\times}\right\rfloor\right)\sideset{_G^I}{}{\hat R(t+\hat t_d)}\\ \sideset{^G}{_I}{\hat p}(t+\hat t_d+\tilde t_d)&=\sideset{^G}{_I}{\hat p}(t+\hat t_d)+\sideset{^G}{_I}{\delta \hat p}(\tilde t_d)=\sideset{^G}{_I}{\hat p}(t+\hat t_d)+\sideset{^G}{_I}{\hat v}(t+\hat t_d)\tilde t_d\end{aligned}\\$ 

**注意这里是坐标变换，只能用左乘**。

## 3.t\_d估计实测  
总结下来，引入 $t_d$估计后算法的改动如下：

1. 状态向量中添加1维状态 $t_d$，初值可以直接设为0，根据对实际系统的同步误差的大致估计，设一个初始协方差。
2. 补偿图像时间戳：每次接收到图像信息后，从估计器获取当前的 $t_d$估计，将其加到图像时间戳上。这样后面IMU Propagation会自动积分到最新的图像时间戳 $t+t_d$，State Augmentation会自动扩增 $t+t_d$时刻的相机状态，这两部分都不需要再做任何改动。
3. 设置 $J_t$：State Augmentation的Jacobian中填写新相机对 $t_d$的Jacobian $J_t$。

$t_d$估计看上去很复杂，其实代码改动量非常少。在EuROC上测试效果，EuROC的数据同步误差比较小，为了凸显改进效果，先人工将图像时间戳加10ms，可以看到 $t_d$能随着运动渐渐收敛到-10ms。 $（图像真实时间戳=当前时间戳+t_d）$

![]((20190813)MSCKF那些事九算法改进2时间同步与同步误差估计_紫薯萝卜/v2-4f1f9cde6ab075b84597d58da1cb5cbc_1440w.jpg)  


同步误差在线标定结果

  
  
## 参考文献  
[1] Li M, Mourikis A I. Online temporal calibration for camera-IMU systems[M]. Sage Publications, Inc. 2014

