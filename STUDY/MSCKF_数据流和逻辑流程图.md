# MSCKF 数据流和逻辑流程图

## 1. 整体系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   传感器输入     │    │   前端处理      │    │   后端处理      │
│                │    │                │    │                │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │   IMU数据   │ │───▶│ │ImageProcessor│ │───▶│ │ MsckfVio    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│ ┌─────────────┐ │    │                │    │                │
│ │ 双目图像    │ │───▶│                │    │                │
│ └─────────────┘ │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 2. 前端 ImageProcessor 数据流

### 2.1 输入数据流
```
IMU数据 ──┐
          ├──► imuCallback() ──► imu_msg_buffer
双目图像 ──┘
          └──► stereoCallback() ──► 特征跟踪处理
```

### 2.2 特征跟踪流程 (trackFeatures)
```
上一帧特征点
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                    trackFeatures()                          │
│                                                             │
│ 1. 左图前后帧跟踪                                            │
│    ├─ integrateImuData() ──► 计算相对旋转                   │
│    ├─ predictFeatureTracking() ──► 预测特征点位置           │
│    └─ LK光流跟踪 ──► 得到当前帧左图特征点                   │
│                                                             │
│ 2. 左右图跟踪                                                │
│    ├─ 相机外参预测 ──► 预测右图特征点位置                   │
│    └─ LK光流跟踪 ──► 得到当前帧右图特征点                   │
│                                                             │
│ 3. RANSAC剔除外点                                            │
│    ├─ 左图前后帧RANSAC                                       │
│    └─ 右图前后帧RANSAC                                       │
└─────────────────────────────────────────────────────────────┘
     │
     ▼
当前帧特征点 ──► publish features ──► 后端接收
```

### 2.3 网格管理
```
图像 (4×5网格)
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                    网格特征管理                              │
│                                                             │
│ 每个网格最多4个特征点                                        │
│ ├─ 特征点均匀分布                                            │
│ ├─ 生存时间长的特征点优先保留                                 │
│ └─ 新特征点提取和分配                                        │
└─────────────────────────────────────────────────────────────┘
```

## 3. 后端 MsckfVio 数据流

### 3.1 输入数据流
```
IMU数据 ──┐
          ├──► imuCallback() ──► imu_msg_buffer
特征数据 ──┘
          └──► featureCallback() ──► 后端处理流程
```

### 3.2 后端主处理流程 (featureCallback)
```
特征数据到达
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                  featureCallback()                          │
│                                                             │
│ 1. batchImuProcessing()                                     │
│    ├─ 处理两帧之间的所有IMU数据                              │
│    ├─ IMU预积分                                             │
│    └─ 状态预测 (EKF Prediction)                             │
│                                                             │
│ 2. stateAugmentation()                                      │
│    ├─ 将当前IMU状态加入相机状态                              │
│    ├─ 扩充状态向量                                          │
│    └─ 扩充协方差矩阵 (6×6)                                  │
│                                                             │
│ 3. addFeatureObservations()                                 │
│    ├─ 将特征添加到map_server                                │
│    ├─ 更新特征观测记录                                       │
│    └─ 计算跟踪比例                                           │
│                                                             │
│ 4. removeLostFeatures()                                     │
│    ├─ 处理跟丢的特征                                         │
│    ├─ 特征三角化                                            │
│    └─ 观测更新 (EKF Update)                                 │
│                                                             │
│ 5. pruneCamStateBuffer()                                    │
│    ├─ 检查相机状态数量                                       │
│    ├─ 移除冗余相机状态                                       │
│    └─ 观测更新 (EKF Update)                                 │
└─────────────────────────────────────────────────────────────┘
     │
     ▼
发布位姿估计结果
```

## 4. 详细处理步骤

### 4.1 IMU处理 (batchImuProcessing)
```
IMU数据缓冲区
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                batchImuProcessing()                         │
│                                                             │
│ for each IMU message in buffer:                             │
│   ├─ processModel()                                         │
│   │   ├─ 计算状态转移矩阵 F                                 │
│   │   ├─ 计算噪声矩阵 G                                     │
│   │   └─ 状态预测                                           │
│   │                                                         │
│   └─ predictNewState()                                      │
│       ├─ 姿态积分 (四元数)                                  │
│       ├─ 速度积分 (4阶Runge-Kutta)                          │
│       └─ 位置积分 (4阶Runge-Kutta)                          │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 状态扩增 (stateAugmentation)
```
当前IMU状态
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                stateAugmentation()                          │
│                                                             │
│ 1. 计算相机位姿                                             │
│    ├─ R_w_c = R_i_c * R_w_i                                │
│    └─ t_c_w = t_w_i + R_w_i^T * t_c_i                      │
│                                                             │
│ 2. 创建新相机状态                                           │
│    ├─ 位置: t_c_w                                          │
│    ├─ 姿态: R_w_c                                          │
│    └─ 时间戳: current_time                                  │
│                                                             │
│ 3. 扩充协方差矩阵                                           │
│    ├─ 新相机自身协方差                                      │
│    └─ 与IMU状态的交叉协方差                                 │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 特征观测添加 (addFeatureObservations)
```
特征数据
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│              addFeatureObservations()                       │
│                                                             │
│ for each feature in message:                                │
│   ├─ 检查特征是否在map_server中                              │
│   │                                                         │
│   ├─ 如果存在:                                              │
│   │   └─ 添加新观测到observations                           │
│   │                                                         │
│   └─ 如果不存在:                                            │
│       ├─ 创建新特征                                          │
│       ├─ 初始化观测记录                                      │
│       └─ 添加到map_server                                   │
│                                                             │
│ 计算跟踪比例统计                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 移除丢失特征 (removeLostFeatures)
```
map_server中的特征
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│              removeLostFeatures()                           │
│                                                             │
│ for each feature in map_server:                             │
│   ├─ 检查特征是否在当前帧中                                  │
│   │                                                         │
│   ├─ 如果丢失:                                              │
│   │   ├─ 检查观测数量 ≥ 3                                   │
│   │   │                                                     │
│   │   ├─ 如果观测足够:                                      │
│   │   │   ├─ 特征三角化                                     │
│   │   │   ├─ 计算观测雅可比                                 │
│   │   │   ├─ 构建观测模型                                   │
│   │   │   └─ EKF更新                                        │
│   │   │                                                     │
│   │   └─ 从map_server移除                                   │
│   │                                                         │
│   └─ 如果未丢失: 继续跟踪                                    │
└─────────────────────────────────────────────────────────────┘
```

### 4.5 相机状态修剪 (pruneCamStateBuffer)
```
相机状态缓冲区
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│              pruneCamStateBuffer()                          │
│                                                             │
│ 1. 检查相机状态数量                                          │
│    ├─ 如果 < max_cam_state_size: 返回                       │
│    └─ 如果 ≥ max_cam_state_size: 继续                       │
│                                                             │
│ 2. findRedundantCamStates()                                 │
│    ├─ 选择key state (倒数第4个)                             │
│    ├─ 检查倒数第3,2个状态                                   │
│    │   ├─ 如果距离和角度都很小: 移除                        │
│    │   └─ 否则: 移除最老的状态                              │
│    └─ 确定要移除的相机状态                                   │
│                                                             │
│ 3. 处理相关特征                                              │
│    ├─ 查找涉及的特征                                         │
│    ├─ 如果观测数=1: 直接移除                                │
│    ├─ 如果观测数>1: 尝试三角化                              │
│    └─ 构建观测模型进行EKF更新                                │
└─────────────────────────────────────────────────────────────┘
```

## 5. 关键数据结构

### 5.1 状态服务器 (StateServer)
```cpp
struct StateServer {
    IMUState imu_state;           // IMU状态 (15维)
    CamStateServer cam_states;    // 相机状态集合 (6N维)
    MatrixXd state_cov;           // 状态协方差矩阵
    Matrix<double, 12, 12> continuous_noise_cov;  // 连续噪声协方差
};
```

### 5.2 特征服务器 (map_server)
```cpp
map<FeatureIDType, Feature> map_server;
// Feature包含:
// - 特征ID
// - 观测记录 (相机ID -> 2D坐标)
// - 3D坐标估计
// - 三角化状态
```

### 5.3 网格特征 (GridFeatures)
```cpp
map<int, vector<FeatureMetaData>> GridFeatures;
// 每个网格最多4个特征点
// 特征按响应强度排序
// 优先保留生存时间长的特征
```

## 6. 观测更新触发条件

### 6.1 两种触发情况
```
观测更新触发
     │
     ├─ 特征跟丢 (removeLostFeatures)
     │   ├─ 特征不再被跟踪
     │   ├─ 观测数量 ≥ 3
     │   └─ 三角化成功
     │
     └─ 相机状态修剪 (pruneCamStateBuffer)
         ├─ 相机状态数量达到上限
         ├─ 选择冗余状态移除
         └─ 相关特征需要处理
```

### 6.2 观测模型构建
```
特征观测数据
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                  观测模型构建                                │
│                                                             │
│ 1. 特征三角化                                               │
│    ├─ 最小二乘优化                                          │
│    ├─ 逆深度参数化                                          │
│    └─ 3D坐标估计                                            │
│                                                             │
│ 2. 重投影误差计算                                           │
│    ├─ 预测投影坐标                                           │
│    ├─ 实际观测坐标                                           │
│    └─ 残差计算                                              │
│                                                             │
│ 3. 雅可比矩阵计算                                           │
│    ├─ 对状态向量的雅可比                                     │
│    ├─ 对特征点的雅可比                                       │
│    └─ 左零空间投影                                          │
│                                                             │
│ 4. EKF更新                                                  │
│    ├─ 卡尔曼增益计算                                         │
│    ├─ 状态更新                                              │
│    └─ 协方差更新                                            │
└─────────────────────────────────────────────────────────────┘
```

## 7. 初始化过程

### 7.1 静止初始化 (initializeGravityAndBias)
```
前200帧IMU数据
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│            initializeGravityAndBias()                       │
│                                                             │
│ 1. 计算平均加速度                                           │
│    ├─ 平均加速度模值 = g                                    │
│    └─ 重力向量 = (0, 0, -g)                                 │
│                                                             │
│ 2. 计算平均角速度                                           │
│    └─ 陀螺仪bias = 平均角速度                               │
│                                                             │
│ 3. 计算初始旋转                                             │
│    ├─ 重力向量与平均加速度夹角                              │
│    └─ IMU系到世界系的旋转四元数                             │
│                                                             │
│ 注意: 要求前200帧IMU静止不动                                │
└─────────────────────────────────────────────────────────────┘
```

这个流程图展示了MSCKF算法的完整数据流和逻辑结构，从前端的特征跟踪到后端的EKF处理，以及各个关键步骤的详细实现。

